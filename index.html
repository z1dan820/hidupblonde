<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deteksi Tangan & Kontrol Tema</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js" crossorigin="anonymous"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Transisi untuk pergantian tema */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        h1, h2 {
            font-family: 'Poppins', sans-serif;
            transition: color 0.3s ease;
        }
        
        /* Styling untuk scrollbar (opsional) */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }

        /* --- TAMBAHAN: Styling untuk Tema Warm --- */
        body.theme-warm {
            background-color: #f7f3e8; /* Latar belakang warm */
            color: #3d2c2c; /* Teks warm */
        }
        body.theme-warm h1 {
            color: #d97706; /* Judul warm (Amber-700) */
        }
        body.theme-warm .video-container {
            background-color: #eaddc7; /* Kontainer video warm */
            border-color: #d97706; /* Border warm */
        }
        body.theme-warm .loading-overlay {
            background-color: rgba(247, 243, 232, 0.8); /* Loading overlay warm */
        }
        body.theme-warm .loading-box {
            background-color: #eaddc7; /* Box loading warm */
            color: #3d2c2c; /* Teks loading warm */
        }
        body.theme-warm .loading-spinner {
            border-color: #d97706;
            border-top-color: transparent;
            border-bottom-color: #d97706;
        }
        body.theme-warm #theme-toggle-button {
            background-color: #eaddc7;
            border-color: #d97706;
            color: #3d2c2c;
        }
        body.theme-warm ::-webkit-scrollbar-track { background: #eaddc7; }
        body.theme-warm ::-webkit-scrollbar-thumb { background: #c08a5f; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <h1 class="text-4xl md:text-5xl font-extrabold text-green-400 mb-8 tracking-tight text-center">
        Machine Learning Part 2<br class="md:hidden"> by Fahrul Hamzidan Pulungan
    </h1>

    <div class="video-container relative w-full max-w-4xl aspect-video rounded-xl overflow-hidden shadow-2xl bg-gray-800 border-2 border-green-500">
        
        <video id="webcam" class="absolute top-0 left-0 w-full h-full object-cover transform -scale-x-1" playsinline></video>
        
        <canvas id="output-canvas" class="absolute top-0 left-0 w-full h-full object-cover transform -scale-x-1 z-5"></canvas>
        
        <div id="display-layer" class="absolute top-0 left-0 w-full h-full z-10 pointer-events-none">
            <img id="image-overlay"    
                 src="dafcc0dabb25e88540586e71209e6763.jpg"    
                 alt="Layer Foto"    
                 class="absolute top-5 left-1/2 -translate-x-1/2 w-80 h-auto z-20 hidden rounded-lg shadow-lg"
            >

            <div id="theme-toggle-button" class="absolute top-5 right-5 w-20 h-20 bg-gray-700 rounded-full border-4 border-gray-500 shadow-lg transition-all duration-300 pointer-events-none">
                <span id="theme-icon" class="absolute inset-0 flex items-center justify-center text-3xl">‚òÄÔ∏è</span>
            </div>
        </div>

        <div id="loading-message" class="loading-overlay absolute inset-0 flex items-center justify-center z-30 bg-gray-900 bg-opacity-80 backdrop-blur-sm">
            <div class="loading-box text-center p-6 rounded-lg bg-gray-700 shadow-xl">
                <div class="loading-spinner animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-400 mx-auto"></div>
                <p class="text-xl font-semibold mt-6 text-gray-50">Memuat Model ML & Menyalakan Webcam...</p>
                <p class="text-sm text-gray-300 mt-2">Harap izinkan akses kamera di browser Anda.</p>
            </div>
        </div>
    </div>

    <audio id="sound-effect" src="SnapTik.Net_7507124144270478648.mp3" preload="auto"></audio>

<script type="module">
    const videoElement = document.getElementById('webcam');
    const loadingMessage = document.getElementById('loading-message');
    const imageOverlay = document.getElementById('image-overlay');
    const soundEffect = document.getElementById('sound-effect');

    // Elemen untuk marking & tombol
    const canvasElement = document.getElementById('output-canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const themeToggleButton = document.getElementById('theme-toggle-button');
    const themeIcon = document.getElementById('theme-icon');
    const bodyElement = document.body;

    // Variabel status untuk tombol tema
    let isWarmTheme = false;
    let lastToggleTime = 0;
    const toggleCooldown = 1000; // 1 detik cooldown

    // Variabel status untuk deteksi kepal
    let isFistDetected = false;

    const FINGER_TIP_INDICES = { THUMB: 4, INDEX: 8, MIDDLE: 12, RING: 16, PINKY: 20 };
    const FINGER_PIP_INDICES = { THUMB: 3, INDEX: 6, MIDDLE: 10, RING: 14, PINKY: 18 };

    function countFingers(landmarks) {
        let count = 0;
        if (!landmarks) return 0;
        
        if (landmarks[FINGER_TIP_INDICES.THUMB].x < landmarks[FINGER_PIP_INDICES.THUMB].x) { count++; }
        if (landmarks[FINGER_TIP_INDICES.INDEX].y < landmarks[FINGER_PIP_INDICES.INDEX].y) { count++; }
        if (landmarks[FINGER_TIP_INDICES.MIDDLE].y < landmarks[FINGER_PIP_INDICES.MIDDLE].y) { count++; }
        if (landmarks[FINGER_TIP_INDICES.RING].y < landmarks[FINGER_PIP_INDICES.RING].y) { count++; }
        if (landmarks[FINGER_TIP_INDICES.PINKY].y < landmarks[FINGER_PIP_INDICES.PINKY].y) { count++; }
        return Math.min(count, 5);
    }

    // --- FUNGSI onResults YANG DIPERBARUI TOTAL ---
    function onResults(results) {
        if (loadingMessage) {
            loadingMessage.style.display = 'none';
        }

        // Setup dan bersihkan canvas
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;

        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        let currentFistState = false;    
        
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            // --- 1. Menggambar landmarks (Marking) ---
            for (const landmarks of results.multiHandLandmarks) {
                window.drawConnectors(canvasCtx, landmarks, window.HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});
                window.drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', radius: 4, lineWidth: 2});
            }
            
            const landmarks = results.multiHandLandmarks[0];

            // --- 2. Logika Deteksi Jari Mengepal (Kode Asli) ---
            const detectedNumber = countFingers(landmarks);
            if (detectedNumber === 0) {
                currentFistState = true;
            }
            
            // --- 3. LOGIKA TOMBOL TEMA YANG DIPERBARUI (FIX) ---
            const indexTip = landmarks[FINGER_TIP_INDICES.INDEX]; // Ujung Jari Telunjuk (#8)
            
            if (indexTip) {
                const buttonRect = themeToggleButton.getBoundingClientRect();
                const videoRect = videoElement.getBoundingClientRect();
                
                // --- INI LOGIKA BARU UNTUK object-cover ---
                
                // Rasio aspek video sumber (misal: 640/480 = 1.333)
                const videoIntrinsicAR = videoElement.videoWidth / videoElement.videoHeight;
                // Rasio aspek elemen HTML (misal: 1280/720 = 1.777)
                const videoElementAR = videoRect.width / videoRect.height;
                
                let visibleVideoWidth = videoRect.width;
                let visibleVideoHeight = videoRect.height;
                let xOffset = videoRect.left;
                let yOffset = videoRect.top;

                if (videoIntrinsicAR > videoElementAR) {
                    // Video lebih lebar dari elemen (misal: 16:9 di kotak 4:3)
                    // `object-cover` akan memotong sisi kiri/kanan
                    visibleVideoWidth = videoRect.height * videoIntrinsicAR;
                    xOffset = videoRect.left - (visibleVideoWidth - videoRect.width) / 2;
                } else if (videoIntrinsicAR < videoElementAR) {
                    // Video lebih tinggi dari elemen (misal: 4:3 di kotak 16:9) <- KASUS UMUM
                    // `object-cover` akan memotong sisi atas/bawah
                    visibleVideoHeight = videoRect.width / videoIntrinsicAR;
                    yOffset = videoRect.top - (visibleVideoHeight - videoRect.height) / 2;
                }
                // Jika rasio sama, xOffset/yOffset/width/height tetap sesuai videoRect.
                
                // Konversi koordinat landmark (0.0 - 1.0) ke koordinat layar (pixel)
                // Kita gunakan offset dan skala yang baru dihitung
                const landmarkScreenX = xOffset + (1 - indexTip.x) * visibleVideoWidth;
                const landmarkScreenY = yOffset + indexTip.y * visibleVideoHeight;

                // --- AKHIR DARI LOGIKA BARU ---

                // Cek apakah landmark ada di dalam area tombol
                const isTouching = (
                    landmarkScreenX > buttonRect.left &&
                    landmarkScreenX < buttonRect.right &&
                    landmarkScreenY > buttonRect.top &&
                    landmarkScreenY < buttonRect.bottom
                );

                const now = Date.now();
                if (isTouching && (now - lastToggleTime > toggleCooldown)) {
                    lastToggleTime = now; 
                    
                    isWarmTheme = !isWarmTheme;
                    bodyElement.classList.toggle('theme-warm', isWarmTheme);
                    
                    themeIcon.innerText = isWarmTheme ? 'üåô' : '‚òÄÔ∏è';
                    console.log("Tema diubah ke:", isWarmTheme ? "Warm" : "Dark");
                }
            }

        } else {
            currentFistState = false;    
        }

        // --- Logika untuk memicu gambar dan suara (Kode Asli) ---
        if (currentFistState && !isFistDetected) {
            console.log("Status: Tangan Mengepal Terdeteksi!");
            isFistDetected = true;
            imageOverlay.classList.remove('hidden');
            soundEffect.currentTime = 0;    
            soundEffect.play();
        } else if (!currentFistState && isFistDetected) {
            console.log("Status: Tangan Dilepas.");
            isFistDetected = false;
            imageOverlay.classList.add('hidden');
            soundEffect.pause();    
        }

        canvasCtx.restore();
    }

    const hands = new window.Hands({
        locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${file}`;
        }
    });

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
    });

    hands.onResults(onResults);

    const camera = new window.Camera(videoElement, {
        onFrame: async () => {
            await hands.send({ image: videoElement });
        },
        width: 1280,
        height: 720
    });
    
    camera.start();

</script>
</body>
</html>
